<!DOCTYPE html>
<html>
	<head>
		<style>
      		#map_canvas {
        		width: 100%;
        		height: 400px;
        		background-color: #CCC;
      		}
    	</style>
      <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    	<script src="https://maps.googleapis.com/maps/api/js"></script>
    	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    	<script src="jquery.xml2json.js" type="text/javascript" language="javascript"></script>
      <script src="racePace.js" type="text/javascript" language="javascript"></script>

      <script>
    	var map;

  			function initialize() {
  				var mapCanvas = document.getElementById('map_canvas');
  				var mapOptions = {
		          center: new google.maps.LatLng(0, 0),
		          zoom: 1,
		          mapTypeId: google.maps.MapTypeId.ROADMAP
		        }
    			
		        map = new google.maps.Map(mapCanvas, mapOptions);

		        console.log(map);
  			}

  			google.maps.event.addDomListener(window, 'load', initialize);
		</script>

    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
    </script>

    <script>
      function handleFileSelect(evt) {
          var dataArray = [];
          var files = evt.target.files;

          output = escape(files[0].name);

          console.log(files[0]);

          document.getElementById('list').innerHTML = output;

          var reader = new FileReader();

          console.log(reader);

          reader.onload = (function(theFile) {
            return function(e) {

              //document.getElementById('list').innerHTML = e.target.result;

              var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

              var results = $.xml2json(e.target.result);

              if(results)
              {
                var list = results.trk.trkseg.trkpt;
                var i;
                var cords = [];
                var n,s,e,w;

                n = parseFloat(list[0].lon);
                s = parseFloat(list[0].lon);
                e = parseFloat(list[0].lat);
                w = parseFloat(list[0].lat);

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(list[0].lat, list[0].lon),
                    map: map,
                  });

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(list[list.length-1].lat, list[list.length-1].lon),
                    map: map,
                  });

                for(i=0;i<list.length;i++)
                {
                  list[i].lat = parseFloat(list[i].lat);
                  list[i].lon = parseFloat(list[i].lon);
                  cords.push(new google.maps.LatLng(list[i].lat, list[i].lon));

                  
                  if(list[i].lat > w)
                    w = list[i].lat;

                  if(list[i].lat < e)
                    e = list[i].lat;
                

                  if(list[i].lon > s)
                    s = list[i].lon;

                  if(list[i].lon < n)
                    n = list[i].lon;
                }

              var flightPath = new google.maps.Polyline({
                    path: cords,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                });

              flightPath.setMap(map);

              map.setZoom(11);
              //map.panToBounds(new google.maps.LatLngBounds(new google.maps.LatLng(w,s), new google.maps.LatLng(e,n)));

              console.log(w + e);
              console.log(n + s);
              map.setCenter(new google.maps.LatLng((w + e) / 2, (n+s)/2));
              }

              var oldTime = list[list.length-1].time;
              var newTime = 0;

              var oldCount = list.length;
              var newCount = 0;

              var data = [['Time','Orig','Race Pace']];

              fillKPHForData(list, 1, data);

              var output = rp_calc(list);

              fillKPHForData(list, 2, data);

              var options = {
                title: 'Speed Over Distance'
              };

              chart.draw(google.visualization.arrayToDataTable(data), options);

              newTime = list[list.length-1].time;
              newCount = list.length;

              document.getElementById('list').innerHTML = "(" + oldCount + ") " + oldTime + " : (" + newCount + ") " + newTime + "<br>" + output;

              console.log(results);
            };
          })(files[0]);

          reader.readAsText(files[0]);
        }

        console.log('Done...');
    </script>
	</head>
	<body>
		<div id="map_canvas"></div>

		Select .GPX file to upload:<input type="file" id="files" name="files[]" multiple accept="text/gpx"></input>
    <script>
      document.getElementById('files').addEventListener('change', handleFileSelect, false);
    </script>
    <div id="chart_div" style="width: 100%; height: 500px;"></div>
		<br>
		<output id="list">...</output>
    
	</body>
</html>